<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Calorie Tracker Pro</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="config.js"></script>
    <style>
    /* iOS-style toggle switch */
    .switch { position: relative; display: inline-block; width:46px; height:28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #d1d1d6; transition: .18s; border-radius: 999px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; top: 3px; background: #fff; transition: .18s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.25); }
    .switch input:checked + .slider { background: #34c759; }
    .switch input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="main-nav">
        <div class="nav-brand">ğŸ“Š Tracker Pro</div>
        <div class="nav-links">
            <a href="../index.html" class="nav-btn" style="text-decoration: none;">
                <span class="icon">â†</span>
                <span class="label">Apps</span>
            </a>
            <button id="tab-tracker" class="nav-btn active" onclick="showPage('tracker')">
                <span class="icon">â•</span>
                <span class="label">Add Entry</span>
            </button>
            <button id="tab-history" class="nav-btn" onclick="showPage('history')">
                <span class="icon">ğŸ“‹</span>
                <span class="label">History</span>
            </button>
            <button id="tab-analytics" class="nav-btn" onclick="showPage('analytics')">
                <span class="icon">ğŸ“ˆ</span>
                <span class="label">Analytics</span>
            </button>
            <button id="tab-settings" class="nav-btn" onclick="showPage('settings')">
                <span class="icon">âš™ï¸</span>
                <span class="label">Settings</span>
            </button>
            <button id="tab-logs" class="nav-btn" onclick="toggleLogs()">
                <span class="icon">ğŸ”</span>
                <span class="label">Logs</span>
            </button>
        </div>
    </nav>

    <!-- PAGE: ADD ENTRY (TRACKER) -->
    <div id="page-tracker" class="page active">
        <div class="page-header">
            <div class="header-actions">
                <button class="icon-btn" onclick="reloadApp()" title="Refresh Data">ğŸ”„</button>
                <div style="display: flex; gap: 8px; padding-left: 8px; border-left: 1px solid var(--border);">
                    <button class="btn-secondary" onclick="fetchFromGit(true)" style="padding: 10px 16px; font-size: 14px;">â¬‡ï¸ Fetch Today</button>
                    <!-- Publish button removed: per-day auto-sync in use -->
                </div>
                <div style="display:flex; align-items:center; gap:8px; padding-left:8px; border-left: 1px solid var(--border);">
                    <button id="date-btn" class="btn-secondary" style="padding: 8px 12px; font-size: 13px;">Date</button>
                </div>
                <div style="display: flex; gap: 8px; padding-left: 8px; border-left: 1px solid var(--border);">
                    <button class="btn-secondary" onclick="openCsvImport()" style="padding: 10px 16px; font-size: 14px;">ğŸ“„ Import CSV</button>
                    <button id="select-mode-btn" class="btn-secondary" onclick="toggleSelectMode()" style="padding: 10px 16px; font-size: 14px;">â˜‘ï¸ Select</button>
                </div>
            </div>
            <h1>Today's Entries</h1>
        </div>
        
        <div id="bulk-actions">
            <button class="btn-secondary" onclick="selectAll()" style="flex: 1;">â˜‘ï¸ Select All</button>
            <button class="btn-danger" onclick="bulkDelete()" style="flex: 1;">ğŸ—‘ï¸ Delete Selected (<span id="selected-count">0</span>)</button>
            <button class="btn-secondary" onclick="exportSelectedToCsv()" style="flex: 1;">ğŸ“„ Export to CSV</button>
        </div>
        
        <!-- Prominent budget bar replaces the old 'Total Today' stat -->
        <div class="prominent-budget-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700; font-size:18px;">Daily Budget</div>
                <div id="budget-values" style="font-size:14px; color:var(--text-secondary);">0 / 2000 kcal</div>
            </div>
            <div class="budget-bar-outer" aria-hidden="false">
                <div id="budget-bar-fill" class="budget-bar-fill" style="width: 0%; display:flex;">
                    <div id="budget-seg-fat" class="budget-seg fat" title="Fat"></div>
                    <div id="budget-seg-protein" class="budget-seg protein" title="Protein"></div>
                    <div id="budget-seg-carbs" class="budget-seg carbs" title="Carbs"></div>
                </div>
            </div>
        </div>

        <div class="container" id="list-container"></div>
        
        <div class="form-panel">
            <h3>Add New Entry</h3>
            <div class="controls" id="form-container">
                <!-- Form fields and button will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- PAGE: HISTORY -->
    <div id="page-history" class="page">
        <div class="page-header">
            <h1>Entry History</h1>
            <div class="header-actions">
                <button class="btn-secondary" onclick="fetchFromGit()" style="padding: 10px 16px; font-size: 14px;">â¬‡ï¸ Fetch Data</button>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <select id="range-select" class="date-filter" onchange="handleRangeSelect()" style="padding: 8px;">
                            <option value="">Select range</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                </div>
                <input type="text" id="filter-food" class="date-filter" placeholder="Search food..." oninput="filterHistory()" style="width: 150px;">
                <button id="history-select-mode-btn" class="btn-secondary" onclick="toggleHistorySelectMode()" style="padding: 10px 16px; font-size: 14px;">â˜‘ï¸ Select</button>
            </div>
        </div>
        
        <div id="history-bulk-actions">
            <button class="btn-secondary" onclick="historySelectAll()" style="flex: 1;">â˜‘ï¸ Select All</button>
            <button class="btn-danger" onclick="historyBulkDelete()" style="flex: 1;">ğŸ—‘ï¸ Delete Selected (<span id="history-selected-count">0</span>)</button>
            <button class="btn-secondary" onclick="historyExportSelectedToCsv()" style="flex: 1;">ğŸ“„ Export to CSV</button>
        </div>
        
        <div class="history-stats">
            <div class="stat-card-small">
                <div class="stat-label">Total Entries</div>
                <div class="stat-value" id="history-total-entries">0</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-label">Total Calories</div>
                <div class="stat-value" id="history-total-calories">0</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-label">Avg/Day</div>
                <div class="stat-value" id="history-avg-calories">0</div>
            </div>
        </div>

        <div class="container" id="history-container"></div>
    </div>

    <!-- PAGE: ANALYTICS -->
    <div id="page-analytics" class="page">
        <div class="page-header">
            <h1>Analytics & Insights</h1>
            <div class="header-actions">
                <input type="date" id="analytics-date" class="date-filter" onchange="updateAnalytics()">
            </div>
        </div>

        <div id="analytics-loading" class="loading-container" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">Loading data...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="analytics-progress"></div>
            </div>
        </div>

        <div id="analytics-content">
            <div class="chart-container">
                <h3>Calorie Distribution by Meal</h3>
                <canvas id="chart-meal-distribution"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Macro Distribution</h3>
                <canvas id="chart-macro-distribution"></canvas>
            </div>

            <div class="chart-container">
                <h3>Health Score vs Macro Amount</h3>
                <p style="color:var(--text-secondary); font-size:13px; margin-top:6px;">Shows average macro amount per Health Score bin. Toggle normalization or raw points.</p>
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
                    <label style="font-size:13px; color:var(--text-secondary);">Mode:
                        <select id="macro-health-mode" onchange="updateAnalytics()" style="margin-left:8px; padding:6px; font-size:13px;">
                            <option value="absolute">Absolute (g)</option>
                            <option value="per100kcal">Per 100 kcal</option>
                        </select>
                    </label>
                    <label style="font-size:13px; color:var(--text-secondary); display:flex; align-items:center; gap:10px;">
                        <span>Show raw points</span>
                        <label class="switch" aria-label="Show raw points">
                            <input type="checkbox" id="macro-health-points" checked onchange="updateAnalytics()">
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <canvas id="chart-macro-health-distribution"></canvas>
            </div>
        </div>
    </div>

    <!-- PAGE: SETTINGS -->
    <div id="page-settings" class="page">
        <div class="page-header">
            <h1>Settings</h1>
        </div>

        <div class="settings-section">
            <h3>ğŸ” GitHub Configuration</h3>
            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" id="cfg-token" placeholder="ghp_..." class="form-input">
            </div>
            <div class="form-group">
                <label>Repository Path</label>
                <input type="text" id="cfg-repo" placeholder="username/repo-name" class="form-input">
            </div>
            <div class="form-group">
                <div style="font-weight: 600;">ğŸ”„ Auto-Save is always enabled</div>
                <div style="font-size: 13px; color: var(--text-secondary);">All changes are synced automatically to per-day files in the <code>data/</code> folder.</div>
            </div>
            <button class="btn-primary" onclick="saveSettings()">ğŸ’¾ Save & Connect</button>
        </div>

        <div class="settings-section">
            <h3>ğŸ”„ Data Management</h3>
            <button class="btn-secondary" onclick="fetchFromGit()">â¬‡ï¸ Fetch from GitHub</button>
            <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Clear Local Data</button>
        </div>

        <div class="settings-section">
            <h3>ğŸ“± App Info</h3>
            <p><strong>Version:</strong> 2.0.0</p>
            <p><strong>Data File:</strong> <code id="settings-datafile">data/&lt;YYYY-MM-DD&gt;.json</code></p>
            <p><strong>Schema:</strong> <code id="settings-schema">Loading...</code></p>
        </div>

        <div class="settings-section">
            <h3>ğŸ¯ Daily Budget</h3>
            <div class="form-group">
                <label>Daily Calorie Budget (kcal)</label>
                <input type="number" id="cfg-daily-budget" placeholder="2000" class="form-input" min="0">
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="btn-secondary" onclick="saveBudgetToRepo()">ğŸ“¤ Save Budget to Repo</button>
            </div>
            <p style="color: var(--text-secondary); font-size: 13px; margin-top:8px;">Set your target calories per day. The tracker will show a progress bar on the main screen. "Save Budget to Repo" writes budget to budget.json in your repo.</p>
        </div>
    </div>

    <!-- Log Panel (Slide-out) -->
    <aside class="log-panel" id="log-panel" aria-hidden="true">
        <div class="log-header-bar">
            <span>ğŸ” System Logs</span>
            <div class="log-controls">
                <select id="log-level" onchange="updateLogLevel()" title="Log Level">
                    <option value="debug">Debug</option>
                    <option value="info" selected>Info</option>
                    <option value="warn">Warn</option>
                    <option value="error">Error</option>
                </select>
                <select id="log-retention" onchange="updateRetention()" title="Log Retention">
                    <option value="2">2 min</option>
                    <option value="5" selected>5 min</option>
                    <option value="15">15 min</option>
                    <option value="60">60 min</option>
                    <option value="0">All</option>
                </select>
                <button onclick="saveLogs()" class="log-icon-btn" title="Save Logs to GitHub">ğŸ’¾</button>
                <button onclick="copyLogs()" class="log-icon-btn" title="Copy Logs">ğŸ“‹</button>
                <button onclick="clearLogs()" class="log-icon-btn" title="Clear Logs">ğŸ—‘ï¸</button>
                <button onclick="toggleLogs()" class="log-icon-btn" title="Close">âœ•</button>
            </div>
        </div>
        <div id="log-screen"></div>
    </aside>

    <!-- CSV Import Modal -->
    <div id="csv-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“„ Import from CSV</h2>
                <button onclick="closeCsvImport()" class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="csv-input-section">
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">Paste your CSV data below. Expected format:</p>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <pre id="example-csv" style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 12px; color: var(--text-secondary);">date,time,food,calories,protein,carbs,fat,healthScore
                        2026-01-15,9:00 AM,Eggs (2 whole + 2 whites),220,20.0,2.0,10.0,7
                        2026-01-15,,Korean BBQ noodles (90 g),289,7.4,37.4,12.2,6</pre>
                        <button class="btn-secondary" style="height: 40px; margin-top: 8px;" onclick="copyExampleCsv()">ğŸ“‹ Copy</button>
                    </div>
                    <textarea id="csv-input" placeholder="Paste CSV data here..." style="width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 13px; margin: 12px 0;"></textarea>
                    <button class="btn-primary" onclick="parseCsv()" style="width: 100%;">ğŸ” Parse & Preview</button>
                </div>
                
                <div id="csv-preview-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 16px; background: var(--bg); border-radius: 12px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 18px;">Preview</h3>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;"><span id="csv-count">0</span> entries ready to import</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="backToCsvInput()" style="padding: 10px 20px;">â† Back</button>
                            <button class="btn-primary" onclick="importCsvEntries()" style="padding: 10px 20px;">âœ… Import All</button>
                        </div>
                    </div>
                    <div id="csv-preview-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Export Modal -->
    <div id="csv-export-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸ“„ Export CSV</h2>
                <button onclick="closeCsvExportModal()" class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 24px; text-align: center;">
                    Ready to export <strong><span id="csv-export-count">0</span> entries</strong>
                </p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn-primary" onclick="downloadCsv()" style="width: 100%; padding: 16px; font-size: 16px;">
                        ğŸ’¾ Download as File
                    </button>
                    <button class="btn-secondary" onclick="copyCsvToClipboard()" style="width: 100%; padding: 16px; font-size: 16px;">
                        ğŸ“‹ Copy to Clipboard
                    </button>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 20px; text-align: center;">
                    Download saves a .csv file to your device.<br>
                    Copy puts the CSV data in your clipboard for pasting elsewhere.
                </p>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal (iPhone-alarm like) -->
    <div id="time-picker-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:320px;">
            <div class="modal-header">
                <h2>ğŸ•°ï¸ Select Time</h2>
                <button onclick="closeTimePicker()" class="modal-close">âœ•</button>
            </div>
            <div class="modal-body" style="display:flex; gap:12px; justify-content:center; align-items:center; padding: 20px;">
                <select id="tp-hour" style="font-size:20px; padding:8px;">
                </select>
                <span style="font-size:20px;">:</span>
                <select id="tp-minute" style="font-size:20px; padding:8px;">
                </select>
            </div>
            <div style="padding: 16px; display:flex; gap:8px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeTimePicker()">Cancel</button>
                <button class="btn-primary" onclick="confirmTimePicker()">Set</button>
            </div>
        </div>

            
    </div>
    <!-- App-level Confirm Modal -->
    <div id="app-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <h2 id="confirm-title">Confirm</h2>
                <button onclick="closeConfirm()" class="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message" style="font-size:15px; color:var(--text);">Are you sure?</p>
                <div id="confirm-details" style="margin-top:12px; max-height:220px; overflow:auto; color:var(--text-secondary); font-size:13px; border-top:1px dashed var(--border); padding-top:8px; display:none;"></div>
            </div>
            <div style="padding: 16px; display:flex; gap:8px; justify-content: flex-end;">
                <button id="confirm-no" class="btn-secondary">Cancel</button>
                <button id="confirm-yes" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>
    <script src="app.js"></script>
</body>
</html>
