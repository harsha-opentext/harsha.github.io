<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Git Tracker + Logs</title>
    <style>
        :root {
            --bg: #f4f7f6;
            --card: #ffffff;
            --primary: #007aff;
            --success: #28a745;
            --error: #ff3b30;
            --text: #333;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #000;
            color: white;
            padding: 40px 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .entry-card {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- Log Section Styles --- */
        #log-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            border-top: 2px solid #444;
        }
        .log-err { color: #ff6b6b; }
        .log-info { color: #888; }

        .controls {
            background: var(--card);
            padding: 20px;
            border-top: 1px solid #ddd;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; grid-column: span 2; }
        .btn-settings { background: transparent; color: white; font-size: 20px; }

        #settings-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100;
        }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 100%; display: flex; flex-direction: column; gap: 15px; }
    </style>
</head>
<body>

    <header>
        <div>
            <div style="font-size: 11px; opacity: 0.7;">DAILY TOTAL</div>
            <div style="font-size: 24px; font-weight: bold;"><span id="total-kcal">0</span> kcal</div>
        </div>
        <button class="btn-settings" onclick="toggleSettings()">⚙️ Settings</button>
    </header>

    <div class="container" id="list-container">
        <!-- Entries will appear here -->
    </div>

    <!-- System Log Window -->
    <div id="log-container">
        <div class="log-info">System ready. Waiting for config...</div>
    </div>

    <div class="controls">
        <input type="text" id="food-name" placeholder="Food Name">
        <input type="number" id="food-kcal" placeholder="Kcal">
        <button class="btn-add" onclick="addEntry()">Add Entry</button>
        <button class="btn-add" style="background:#666" onclick="fetchFromGit()">Sync from Git</button>
        <button class="btn-save" onclick="pushToGit()">Push to GitHub</button>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h3>API Configuration</h3>
            <p style="font-size: 12px; color: #666;">Enter your details to link the private repo.</p>
            <input type="password" id="config-token" placeholder="GitHub Token (ghp_...)">
            <input type="text" id="config-repo" placeholder="username/repo-name">
            <button class="btn-add" onclick="saveSettings()">Save & Test Connection</button>
            <button onclick="toggleSettings()" style="background: #eee;">Cancel</button>
        </div>
    </div>

    <script>
        let state = { entries: [], sha: "" };

        // --- Logger Helper ---
        function logger(msg, isError = false) {
            const logBox = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = isError ? 'log-err' : '';
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }

        // --- Logic ---
        function csvToJSON(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length <= 1) return [];
            return lines.slice(1).map(line => {
                const [date, food, kcal] = line.split(',');
                return { date, food, kcal: parseInt(kcal) };
            });
        }

        function jsonToCSV(json) {
            return ["date,food,calories", ...json.map(r => `${r.date},${r.food},${r.kcal}`)].join('\n');
        }

        function render() {
            const container = document.getElementById('list-container');
            const totalEl = document.getElementById('total-kcal');
            container.innerHTML = '';
            let total = 0;
            state.entries.forEach(item => {
                total += item.kcal;
                const div = document.createElement('div');
                div.className = 'entry-card';
                div.innerHTML = `<span>${item.food}</span><b>${item.kcal} kcal</b>`;
                container.appendChild(div);
            });
            totalEl.innerText = total;
        }

        function addEntry() {
            const food = document.getElementById('food-name').value;
            const kcal = parseInt(document.getElementById('food-kcal').value);
            if (!food || isNaN(kcal)) return logger("Error: Missing food or kcal", true);

            state.entries.push({ date: new Date().toISOString().split('T')[0], food, kcal });
            render();
            logger(`Added ${food} locally.`);
        }

        // --- GitHub API ---
        async function fetchFromGit() {
            const token = localStorage.getItem('gt_token');
            const repo = localStorage.getItem('gt_repo');

            if (!token || !repo) {
                logger("Error: Token or Repo not set. Click ⚙️.", true);
                return;
            }

            logger(`Fetching data.csv from ${repo}...`);
            try {
                const url = `https://api.github.com/repos/${repo}/contents/data.csv`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' }
                });

                if (!response.ok) {
                    throw new Error(`GitHub returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                state.sha = data.sha;
                const content = decodeURIComponent(escape(atob(data.content)));
                state.entries = csvToJSON(content);
                render();
                logger("Sync successful. Data loaded.");
            } catch (err) {
                logger(err.message, true);
                if (err.message.includes("401")) logger("Check your token permissions (Repo scope needed).", true);
                if (err.message.includes("404")) logger("data.csv not found in this repo.", true);
            }
        }

        async function pushToGit() {
            const token = localStorage.getItem('gt_token');
            const repo = localStorage.getItem('gt_repo');
            if (!token || !repo) return logger("Configuration missing!", true);

            logger("Preparing to push to GitHub...");
            const csvContent = jsonToCSV(state.entries);
            const url = `https://api.github.com/repos/${repo}/contents/data.csv`;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Update: " + new Date().toLocaleString(),
                        content: btoa(unescape(encodeURIComponent(csvContent))),
                        sha: state.sha
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    state.sha = result.content.sha;
                    logger("Push successful! SHA updated.");
                    alert("Saved to GitHub!");
                } else {
                    const errorDetails = await response.json();
                    throw new Error(`Push failed: ${errorDetails.message}`);
                }
            } catch (err) {
                logger(err.message, true);
            }
        }

        // --- Settings ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function saveSettings() {
            const token = document.getElementById('config-token').value.trim();
            const repo = document.getElementById('config-repo').value.trim();
            
            localStorage.setItem('gt_token', token);
            localStorage.setItem('gt_repo', repo);
            
            logger("Settings saved. Testing connection...");
            toggleSettings();
            fetchFromGit();
        }

        window.onload = () => {
            const savedToken = localStorage.getItem('gt_token');
            const savedRepo = localStorage.getItem('gt_repo');
            if (savedToken) document.getElementById('config-token').value = savedToken;
            if (savedRepo) document.getElementById('config-repo').value = savedRepo;
            
            if (savedToken && savedRepo) fetchFromGit();
            else logger("Please open settings to configure your GitHub connection.");
        };
    </script>
</body>
</html>
