<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Git-Base v2 (Debug Pro)</title>
    <style>
        :root { --bg: #f4f7f6; --primary: #007aff; --err: #ff3b30; --text: #333; }
        body, html { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); height: 100%; overflow: hidden; }
        
        /* Navigation Tabs */
        nav { display: flex; background: #000; padding-top: 40px; }
        nav button { flex: 1; padding: 15px; border: none; background: #222; color: #888; font-weight: bold; }
        nav button.active { background: #000; color: #fff; border-bottom: 3px solid var(--primary); }

        .page { display: none; height: calc(100vh - 100px); flex-direction: column; }
        .page.active { display: flex; }

        /* App Page */
        .container { flex: 1; padding: 20px; overflow-y: auto; }
        .entry-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .controls { background: #fff; padding: 20px; border-top: 1px solid #ddd; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--primary); color: white; }
        .btn-save { background: #28a745; color: white; grid-column: span 2; }

        /* Log Page */
        #log-screen { background: #121212; color: #0f0; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; overflow-y: auto; flex: 1; white-space: pre-wrap; word-break: break-all; }
        .log-item { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-warn { color: #ffcc00; }
        .log-header { color: #00d4ff; font-weight: bold; }

        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 100%; display: flex; flex-direction: column; gap: 15px; }
    </style>
</head>
<body>

    <nav>
        <button id="tab-app" class="active" onclick="showPage('app')">TRACKER</button>
        <button id="tab-logs" onclick="showPage('logs')">DEBUG CONSOLE</button>
    </nav>

    <!-- PAGE 1: APP -->
    <div id="page-app" class="page active">
        <header style="padding: 20px; background: #000; color: #fff;">
            <span>TODAY</span>
            <h1 id="total-kcal" style="margin: 0;">0 kcal</h1>
            <button onclick="toggleSettings()" style="margin-top: 10px; font-size: 12px; background: #333; color: #ccc;">⚙️ API CONFIG</button>
        </header>
        <div class="container" id="list-container"></div>
        <div class="controls">
            <input type="text" id="food-name" placeholder="Food Name">
            <input type="number" id="food-kcal" placeholder="Kcal">
            <button class="btn-add" onclick="addEntry()">Add Locally</button>
            <button class="btn-add" style="background:#666" onclick="fetchFromGit()">Fetch Git</button>
            <button class="btn-save" onclick="pushToGit()">Push to GitHub</button>
        </div>
    </div>

    <!-- PAGE 2: LOGS -->
    <div id="page-logs" class="page">
        <div style="padding: 10px; background: #222; display: flex; justify-content: space-between;">
            <span style="color: white;">System Logs</span>
            <button onclick="clearLogs()" style="padding: 2px 10px; font-size: 10px;">Clear</button>
        </div>
        <div id="log-screen"></div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h3>API Settings</h3>
            <input type="password" id="cfg-token" placeholder="Personal Access Token (ghp_...)">
            <input type="text" id="cfg-repo" placeholder="owner/repo (e.g. harsha-opentext/private-data)">
            <button class="btn-add" onclick="saveSettings()">Save & Connect</button>
            <button onclick="toggleSettings()" style="background: #eee;">Close</button>
        </div>
    </div>

    <script>
        let state = { entries: [], sha: "" };

        // --- EXTENSIVE LOGGING SYSTEM ---
        function dbg(msg, type = 'info', raw = null) {
            const screen = document.getElementById('log-screen');
            const item = document.createElement('div');
            item.className = `log-item ${type === 'error' ? 'log-error' : type === 'warn' ? 'log-warn' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString();
            let text = `[${timestamp}] ${msg}`;
            if (raw) text += `\nRAW: ${JSON.stringify(raw, null, 2)}`;
            
            item.innerText = text;
            screen.prepend(item); // Newest logs at top
        }

        function clearLogs() { document.getElementById('log-screen').innerHTML = ''; }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.getElementById(`tab-${p}`).classList.add('active');
        }

        // --- CORE LOGIC ---
        function saveSettings() {
            const t = document.getElementById('cfg-token').value.trim();
            const r = document.getElementById('cfg-repo').value.trim();
            localStorage.setItem('gt_token', t);
            localStorage.setItem('gt_repo', r);
            dbg("Settings saved to LocalStorage");
            dbg(`Token starts with: ${t.substring(0, 4)}...`);
            dbg(`Repo path: ${r}`);
            toggleSettings();
            fetchFromGit();
        }

        async function fetchFromGit() {
            const token = localStorage.getItem('gt_token');
            const repo = localStorage.getItem('gt_repo');

            if (!token || !repo) {
                dbg("CRITICAL: Missing Token or Repo path in settings", "error");
                return;
            }

            const url = `https://api.github.com/repos/${repo}/contents/data.csv`;
            dbg(`INITIATING FETCH`, "log-header");
            dbg(`URL: ${url}`);

            try {
                dbg("Calling fetch()...");
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Cache-Control': 'no-cache'
                    }
                });

                dbg(`HTTP Status: ${response.status} (${response.statusText})`);

                if (!response.ok) {
                    const errBody = await response.json();
                    dbg(`GitHub API Error`, "error", errBody);
                    return;
                }

                const data = await response.json();
                state.sha = data.sha;
                dbg(`SHA Received: ${state.sha}`);

                const content = atob(data.content);
                dbg("Base64 Content Decoded successfully.");
                
                state.entries = parseCSV(content);
                render();
                dbg(`Successfully parsed ${state.entries.length} rows.`);

            } catch (err) {
                dbg("NETWORK ERROR DETECTED", "error");
                dbg(`Message: ${err.message}`);
                dbg(`Stack: ${err.stack}`);
                if (navigator.onLine) {
                    dbg("Device is Online. This might be a CORS block or malformed URL.");
                } else {
                    dbg("Device appears to be OFFLINE.", "warn");
                }
            }
        }

        async function pushToGit() {
            const token = localStorage.getItem('gt_token');
            const repo = localStorage.getItem('gt_repo');
            if (!state.sha) { dbg("Cannot push: No SHA found. Fetch first.", "error"); return; }

            const csvContent = ["date,food,calories", ...state.entries.map(e => `${e.date},${e.food},${e.kcal}`)].join('\n');
            const url = `https://api.github.com/repos/${repo}/contents/data.csv`;

            dbg("INITIATING PUSH", "log-header");
            try {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Sync: " + new Date().toISOString(),
                        content: btoa(csvContent),
                        sha: state.sha
                    })
                });

                if (res.ok) {
                    const json = await res.json();
                    state.sha = json.content.sha;
                    dbg("PUSH SUCCESSFUL", "info");
                    alert("Saved to GitHub!");
                } else {
                    const err = await res.json();
                    dbg("PUSH FAILED", "error", err);
                }
            } catch (err) {
                dbg("PUSH NETWORK ERROR", "error", err);
            }
        }

        function parseCSV(str) {
            const lines = str.trim().split('\n');
            if (lines.length <= 1) return [];
            return lines.slice(1).map(l => {
                const [date, food, kcal] = l.split(',');
                return { date, food, kcal: parseInt(kcal) };
            });
        }

        function render() {
            const container = document.getElementById('list-container');
            const totalEl = document.getElementById('total-kcal');
            container.innerHTML = '';
            let total = 0;
            state.entries.forEach(e => {
                total += e.kcal;
                const d = document.createElement('div');
                d.className = 'entry-card';
                d.innerHTML = `<span>${e.food}</span><b>${e.kcal} kcal</b>`;
                container.appendChild(d);
            });
            totalEl.innerText = `${total} kcal`;
        }

        function addEntry() {
            const f = document.getElementById('food-name').value;
            const k = parseInt(document.getElementById('food-kcal').value);
            if (!f || !k) return;
            state.entries.push({ date: new Date().toISOString().split('T')[0], food: f, kcal: k });
            render();
            dbg(`Added ${f} locally. Pending Push.`);
        }

        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        window.onload = () => {
            dbg("Application Started");
            const t = localStorage.getItem('gt_token');
            const r = localStorage.getItem('gt_repo');
            if (t) document.getElementById('cfg-token').value = t;
            if (r) document.getElementById('cfg-repo').value = r;
            if (t && r) fetchFromGit();
        };
    </script>
</body>
</html>
